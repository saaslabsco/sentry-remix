{"version":3,"file":"web-fetch.js","sources":["../../../src/utils/web-fetch.ts"],"sourcesContent":["// Based on Remix's implementation of Fetch API\n// https://github.com/remix-run/web-std-io/blob/d2a003fe92096aaf97ab2a618b74875ccaadc280/packages/fetch/\n// The MIT License (MIT)\n\n// Copyright (c) 2016 - 2020 Node Fetch Team\n\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n\n// The above copyright notice and this permission notice shall be included in all\n// copies or substantial portions of the Software.\n\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n// SOFTWARE.\n\nimport type { RemixRequest } from './vendor/types';\n\n/*\n * Symbol extractor utility to be able to access internal fields of Remix requests.\n */\nconst getInternalSymbols = (\n  request: Record<string, unknown>,\n): {\n  bodyInternalsSymbol: string;\n  requestInternalsSymbol: string;\n} => {\n  const symbols = Object.getOwnPropertySymbols(request);\n  return {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    bodyInternalsSymbol: symbols.find(symbol => symbol.toString().includes('Body internals')) as any,\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    requestInternalsSymbol: symbols.find(symbol => symbol.toString().includes('Request internals')) as any,\n  };\n};\n\n/**\n * Vendored from:\n * https://github.com/remix-run/web-std-io/blob/f715b354c8c5b8edc550c5442dec5712705e25e7/packages/fetch/src/utils/get-search.js#L5\n */\nexport const getSearch = (parsedURL: URL): string => {\n  if (parsedURL.search) {\n    return parsedURL.search;\n  }\n\n  const lastOffset = parsedURL.href.length - 1;\n  const hash = parsedURL.hash || (parsedURL.href[lastOffset] === '#' ? '#' : '');\n  return parsedURL.href[lastOffset - hash.length] === '?' ? '?' : '';\n};\n\n/**\n * Convert a Request to Node.js http request options.\n * The options object to be passed to http.request\n * Vendored / modified from:\n * https://github.com/remix-run/web-std-io/blob/f715b354c8c5b8edc550c5442dec5712705e25e7/packages/fetch/src/request.js#L259\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport const normalizeRemixRequest = (request: RemixRequest): Record<string, any> => {\n  const { requestInternalsSymbol, bodyInternalsSymbol } = getInternalSymbols(request);\n\n  if (!requestInternalsSymbol && !request.headers) {\n    throw new Error('Could not find request headers');\n  }\n\n  const internalRequest = request[requestInternalsSymbol];\n\n  const parsedURL = internalRequest ? internalRequest.parsedURL : new URL(request.url);\n  const headers = internalRequest ? new Headers(internalRequest.headers) : request.headers;\n\n  // Fetch step 1.3\n  if (!headers.has('Accept')) {\n    headers.set('Accept', '*/*');\n  }\n\n  // HTTP-network-or-cache fetch steps 2.4-2.7\n  let contentLengthValue = null;\n  if (request.body === null && /^(post|put)$/i.test(request.method)) {\n    contentLengthValue = '0';\n  }\n\n  const internalBody = request[bodyInternalsSymbol];\n  if (request.body !== null && internalBody) {\n    const totalBytes = internalBody.size;\n    // Set Content-Length if totalBytes is a number (that is not NaN)\n    if (typeof totalBytes === 'number' && !Number.isNaN(totalBytes)) {\n      contentLengthValue = String(totalBytes);\n    }\n  }\n\n  if (contentLengthValue) {\n    headers.set('Content-Length', contentLengthValue);\n  }\n\n  // HTTP-network-or-cache fetch step 2.11\n  if (!headers.has('User-Agent')) {\n    headers.set('User-Agent', 'node-fetch');\n  }\n\n  // HTTP-network-or-cache fetch step 2.15\n  if (request.compress && !headers.has('Accept-Encoding')) {\n    headers.set('Accept-Encoding', 'gzip,deflate,br');\n  }\n\n  let { agent } = request;\n\n  if (typeof agent === 'function') {\n    agent = agent(parsedURL);\n  }\n\n  if (!headers.has('Connection') && !agent) {\n    headers.set('Connection', 'close');\n  }\n\n  // HTTP-network fetch step 4.2\n  // chunked encoding is handled by Node.js\n  const search = getSearch(parsedURL);\n\n  // Manually spread the URL object instead of spread syntax\n  const requestOptions = {\n    path: parsedURL.pathname + search,\n    pathname: parsedURL.pathname,\n    hostname: parsedURL.hostname,\n    protocol: parsedURL.protocol,\n    port: parsedURL.port,\n    hash: parsedURL.hash,\n    search: parsedURL.search,\n    // @ts-expect-error - it does not has a query\n    query: parsedURL.query,\n    href: parsedURL.href,\n    method: request.method,\n    headers: objectFromHeaders(headers),\n    insecureHTTPParser: request.insecureHTTPParser,\n    agent,\n\n    // [SENTRY] For compatibility with Sentry SDK RequestData parser, adding `originalUrl` property.\n    originalUrl: parsedURL.href,\n  };\n\n  return requestOptions;\n};\n\n// This function is a `polyfill` for Object.fromEntries()\nfunction objectFromHeaders(headers: Headers): Record<string, string> {\n  const result: Record<string, string> = {};\n  let iterator: IterableIterator<[string, string]>;\n\n  if (hasIterator(headers)) {\n    iterator = getIterator(headers) as IterableIterator<[string, string]>;\n  } else {\n    return {};\n  }\n\n  for (const [key, value] of iterator) {\n    result[key] = value;\n  }\n  return result;\n}\n\ntype IterableType<T> = {\n  [Symbol.iterator]: () => Iterator<T>;\n};\n\nfunction hasIterator<T>(obj: T): obj is T & IterableType<unknown> {\n  return obj !== null && typeof (obj as IterableType<unknown>)[Symbol.iterator] === 'function';\n}\n\nfunction getIterator<T>(obj: T): Iterator<unknown> {\n  if (hasIterator(obj)) {\n    return (obj as IterableType<unknown>)[Symbol.iterator]();\n  }\n  throw new Error('Object does not have an iterator');\n}\n"],"names":[],"mappings":"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"}